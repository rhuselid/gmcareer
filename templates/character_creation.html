<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Character Creation — GM Career Mode</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="creation-card">
    <h1>Create Your Manager</h1>
    <p class="intro">
      Allocate <strong>{{ total_points }}</strong> skill points across your manager attributes (0–99 each).
      You'll start as a high school GM and work your way up.
    </p>

    {% if error %}
    <div class="error" role="alert">{{ error }}</div>
    {% endif %}

    <form action="{{ url_for('character_creation_submit') }}" method="post" id="creation-form">
      <div class="profile-section">
        <div class="profile-avatar" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="avatar-silhouette">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </div>
        <div class="profile-fields">
          <div class="profile-name-wrap">
            <label for="manager-name">Name</label>
            <input type="text" id="manager-name" name="name" value="{{ name }}" placeholder="Your name" maxlength="80" class="profile-name">
          </div>
          <div class="profile-name-wrap">
            <label for="seed">Seed (optional)</label>
            <input type="text" id="seed" name="seed" value="{{ seed }}" placeholder="Number or text for reproducible world" maxlength="80" class="profile-name">
          </div>
        </div>
      </div>

      <div class="points-remaining" id="points-remaining">
        Points remaining: <span id="remaining-value">{{ total_points }}</span>
      </div>

      <ul class="skill-list">
        {% for key, label in skills.items() %}
        <li class="skill-row">
          <label for="skill-{{ key }}">{{ label }}</label>
          <div class="skill-controls">
            <button type="button" class="skill-btn skill-btn-minus" data-skill-btn="minus" data-skill-key="{{ key }}" aria-label="Decrease {{ label }}">−</button>
            <input
              type="number"
              id="skill-{{ key }}"
              name="{{ key }}"
              min="0"
              max="99"
              value="{{ values.get(key, 0) }}"
              data-skill
            >
            <button type="button" class="skill-btn skill-btn-plus" data-skill-btn="plus" data-skill-key="{{ key }}" aria-label="Increase {{ label }}">+</button>
          </div>
        </li>
        {% endfor %}
      </ul>

      <button type="submit" id="submit-btn" disabled>Create Manager</button>
    </form>
  </main>

  <script>
    const TOTAL_POINTS = {{ total_points }};
    const MAX_SKILL = 99;
    const inputs = document.querySelectorAll('[data-skill]');
    const remainingEl = document.getElementById('remaining-value');
    const submitBtn = document.getElementById('submit-btn');

    function getUsedPoints() {
      let used = 0;
      inputs.forEach(input => {
        const v = parseInt(input.value, 10) || 0;
        used += Math.max(0, Math.min(MAX_SKILL, v));
      });
      return used;
    }

    function getRemaining() {
      return TOTAL_POINTS - getUsedPoints();
    }

    function updatePoints() {
      const remaining = getRemaining();
      remainingEl.textContent = remaining;
      remainingEl.className = remaining === 0 ? 'valid' : (remaining < 0 ? 'over' : '');
      submitBtn.disabled = remaining !== 0;
    }

    function stepInput(input, delta) {
      const current = parseInt(input.value, 10) || 0;
      const used = getUsedPoints();
      const remaining = getRemaining();
      if (delta > 0) {
        if (current >= MAX_SKILL || remaining <= 0) return;
        input.value = Math.min(MAX_SKILL, current + 1);
      } else {
        if (current <= 0) return;
        input.value = Math.max(0, current - 1);
      }
      input.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function setupHoldRepeat(btn) {
      let intervalId = null;
      let delayId = null;
      let repeatStarted = false;
      const HOLD_DELAY_MS = 400;
      const key = btn.dataset.skillKey;
      const input = document.getElementById('skill-' + key);
      const isPlus = btn.dataset.skillBtn === 'plus';

      function tick() {
        const remaining = getRemaining();
        const current = parseInt(input.value, 10) || 0;
        if (isPlus && (current >= MAX_SKILL || remaining <= 0)) {
          clearInterval(intervalId);
          intervalId = null;
          return;
        }
        if (!isPlus && current <= 0) {
          clearInterval(intervalId);
          intervalId = null;
          return;
        }
        stepInput(input, isPlus ? 1 : -1);
      }

      function startRepeat() {
        repeatStarted = true;
        tick();
        intervalId = setInterval(tick, 120);
      }

      function start() {
        repeatStarted = false;
        delayId = setTimeout(startRepeat, HOLD_DELAY_MS);
      }

      function stop() {
        if (delayId) {
          clearTimeout(delayId);
          delayId = null;
        }
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
        repeatStarted = false;
      }

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        if (!repeatStarted) {
          stepInput(input, isPlus ? 1 : -1);
        }
      });
      btn.addEventListener('mousedown', function (e) {
        e.preventDefault();
        start();
      });
      btn.addEventListener('mouseup', stop);
      btn.addEventListener('mouseleave', stop);
      btn.addEventListener('touchstart', function (e) {
        e.preventDefault();
        start();
      }, { passive: false });
      btn.addEventListener('touchend', stop);
      btn.addEventListener('touchcancel', stop);
    }

    inputs.forEach(input => {
      input.addEventListener('input', updatePoints);
      input.addEventListener('change', updatePoints);
    });
    document.querySelectorAll('[data-skill-btn]').forEach(setupHoldRepeat);
    updatePoints();
  </script>
</body>
</html>
